#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), 'src'))

from shamela_converter import ShamelaConverter

def test_separator_lines():
    """اختبار معالجة الخطوط الفاصلة === و __________"""
    
    # إعداد MySQL config فارغ للاختبار
    mysql_config = {
        'host': 'localhost',
        'user': 'test',
        'password': 'test',
        'database': 'test'
    }
    
    converter = ShamelaConverter(mysql_config)
    
    # النص المثال الذي قدمه المستخدم
    test_text = """بسم الله الرحمن الرحيم 
 حُمِدَ مَن جعلَ العلمَ أجلَّ المواهب الهنيَّة وأسناها، وأعلى المراتب السَّنيَّة وأسماها، أحسنُ ما يفتتح به الكلام، وشكرَ من خصَّ علم الأحكام والشَّرائع، بأنَّه أقوى الوسائل إليه والذرائع، أيمنُ ما يُسْتَنْجَحُ به المرام، فنحمده حمداً لا انصرام لعدده، ولا انفصام لمدده على ما أنعم وأولى من نعمه الظاهرة والباطنة، 
 ـــــــــــــــــــــــــــــ 
 بسم الله الرحمن الرحيم [1] 
 === 
 [1] قوله: بسم الله الرحمن الرحيم؛ ابتدأ به كتابه إتباعاً بخير الكلام، واقتفاءً للإجماع الفعليّ من الكلام، وامتثالاً لقولِه - صلى الله عليه وسلم -: «كل أمرٍ ذي بالٍ (1) لا يبدأ فيه ببسم الله الرحمن الرحيم فهو أقطع»، أخرجه عبد القادر الرهاويّ (2) في «أربعينه» من حديث أبي هريرةَ - رضي الله عنهم -. كذا نسبه السيوطيّ إليه في «الجامع الصغير» (3). 
 __________ 
 (1) أي ذي شأن وشرف لا يبدأ فيه ببسم الله فهو ناقص غير معتد به شرعاً. ينظر: «فيض القدير» (5: 17). 
 (2) وهو عبد القادر بن عبد الله الفهمي الرُّهاوي الحراني، أبو محمَّد، محدِّث الجزيرة، كان مملوكاً لواحد من أكابر الموصل، دار البلاد وأخذ عَن حفاظ الحَدِيث، قيل: له تآليف كثيرة منها «أربعين المتباينة الإسناد والحديث» مجلدان، وهو شيء ما سبقه إليه أحد ولا يرجوه بعده محدّث لخراب البلاد، ومنها: «المادح والممدوح»، و «الفرائض والحساب»، (ت612هـ). ينظر: «مرآة الجنان» (4: 23)، و «الكشف» (5: 596)، و «الأعلام» (4: 165). 
 (3) في «الجامع الصغير» (5: 17) (6284) مع شرحه «فيض القدير» وفيه: «قال ابن حجر: والحديث الذي أشار إليه صححه ابن حبان وفي إسناده مقال. وبتقدير صحته فالرواية المشهورة بلفظ بحمد الله وما عدا ذلك من الألفاظ التي ذكرها النووي وردت في بعض طرق الحديث بأسانيد واهية». وقال الكشميري في «العرف الشذي» (1: 4): «وأما حديث «كل أمر ذي بال لم يبدأ ... » إلخ فمضطرب فإن في بعض ألفاظ: «بحمد الله»، وفي بعضها: «بذكر الله»، وفي بعضها: «ببسم الله»، وقال تاج الدين السبكي: إن الحديث يبلغ مرتبة الحسن، وفي سنده قرة وهو مختلف فيه». وقال العراقي في «تخريج أحاديث الإحياء» (1: 167): «أخرجه أبو داود والنسائي وابن ماجة وابن حبان في صحيحه من حديث أبي هريرة». )"""
    
    print("النص الأصلي:")
    print("=" * 50)
    print(test_text)
    print("\n" + "=" * 50)
    
    # تطبيق معالجة النص
    processed_text = converter.extract_arabic_text_enhanced(test_text)
    print("\nالنص بعد extract_arabic_text_enhanced:")
    print("=" * 50)
    print(processed_text)
    print("\n" + "=" * 50)
    
    # تطبيق تنسيق HTML
    html_output = converter.format_text_to_html(processed_text)
    print("\nالنص بعد format_text_to_html:")
    print("=" * 50)
    print(html_output)
    print("\n" + "=" * 50)
    
    # التحقق من النتائج
    print("\nنتائج الاختبار:")
    print("=" * 30)
    
    # التحقق من وجود === في سطر منفصل
    if '<p style="text-align: center; margin: 10px 0;">===</p>' in html_output:
        print("✓ تم الحفاظ على === في سطر منفصل بشكل صحيح")
    else:
        print("✗ لم يتم الحفاظ على === في سطر منفصل")
    
    # التحقق من وجود الخطوط الفاصلة العربية في سطر منفصل
    arabic_separator_found = False
    for i in range(5, 25):  # البحث عن خطوط بأطوال مختلفة
        separator = 'ـ' * i
        if f'<p style="text-align: center; margin: 10px 0;">{separator}</p>' in html_output:
            arabic_separator_found = True
            break
    
    if arabic_separator_found:
        print("✓ تم الحفاظ على الخطوط الفاصلة العربية ـــــــــ في سطر منفصل بشكل صحيح")
    else:
        print("✗ لم يتم الحفاظ على الخطوط الفاصلة العربية ـــــــــ في سطر منفصل")
    
    # التحقق من عدم تحويل === إلى <br>
    if '===' not in html_output.replace('<p style="text-align: center; margin: 10px 0;">===</p>', ''):
        print("✓ لم يتم تحويل === إلى <br> في أماكن أخرى")
    else:
        print("✗ تم العثور على === في أماكن أخرى غير المطلوبة")
    
    # التحقق من الحفاظ على التشكيل
    if 'حُمِدَ' in html_output and 'مَن' in html_output:
        print("✓ تم الحفاظ على التشكيل والحركات العربية")
    else:
        print("✗ لم يتم الحفاظ على التشكيل والحركات العربية")

if __name__ == "__main__":
    test_separator_lines()